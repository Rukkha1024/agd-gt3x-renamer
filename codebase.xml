<directory>agd-gt3x-renamer</directory>

<source-tree>
agd-gt3x-renamer
â”œâ”€â”€ __pycache__
â”‚   â”œâ”€â”€ modify.cpython-311.pyc
â”‚   â””â”€â”€ name.cpython-311.pyc
â”œâ”€â”€ config.yaml
â”œâ”€â”€ modify.py
â”œâ”€â”€ name.py
â”œâ”€â”€ requirements.txt
â””â”€â”€ temp_test
    â”œâ”€â”€ DB51016001_ê¹€í™ì„  (2025-01-15)60sec.agd
    â””â”€â”€ DB51016001_ê¹€í™ì„  (2025-01-15)60sec.gt3x

</source-tree>

<files>
<file path="config.yaml">
```yaml
# ActiGraph íŒŒì¼ ìë™ ë³€ê²½ ì„¤ì •

# íŒŒì¼ ê²½ë¡œ
paths:
  # ëŒ€ìƒì ì •ë³´ Excel íŒŒì¼
  subject_info: "/mnt/c/Users/Alice/OneDrive - ì²­ì£¼ëŒ€í•™êµ/VScode_Repository/agd-gt3x-renamer/Archive/ëŒ€ìƒì í‚¤,ì²´ì¤‘,ì£¼ì† ì •ë³´.xlsx"

  # ê´€ë¦¬ë²ˆí˜¸-ì‹œë¦¬ì–¼ë²ˆí˜¸ ë§¤ì¹­ Excel íŒŒì¼
  serial_mapping: "/mnt/c/Users/Alice/OneDrive - ì²­ì£¼ëŒ€í•™êµ/VScode_Repository/agd-gt3x-renamer/ê´€ë¦¬ë²ˆí˜¸-ì‹œë¦¬ì–¼ë²ˆí˜¸.xlsx"

  # ActiGraph íŒŒì¼ì´ ì €ì¥ëœ ë””ë ‰í† ë¦¬
  target_directory: "/mnt/c/Users/Alice/OneDrive - ì²­ì£¼ëŒ€í•™êµ/VScode_Repository/agd-gt3x-renamer/temp_test"

# Excel ì»¬ëŸ¼ ì„¤ì •
columns:
  # ê´€ë¦¬ë²ˆí˜¸-ì‹œë¦¬ì–¼ë²ˆí˜¸.xlsx
  serial_mapping:
    management_number: "ê´€ë¦¬ë²ˆí˜¸"
    serial_number: "ê³ ìœ ë²ˆí˜¸"
  
  # ëŒ€ìƒì í‚¤,ì²´ì¤‘,ì£¼ì† ì •ë³´.xlsx
  subject_info:
    division: "êµ¬ë¶„"
    management_number: "ê´€ë¦¬ë²ˆí˜¸"
    id: "ID"
    name: "ì´ë¦„"
    wear_start_date: "ì°©ìš© ì‹œì‘ì¼"
    # ë©”íƒ€ë°ì´í„° ì¶”ê°€ ì»¬ëŸ¼ (Progress 04)
    sex: "ì„±ë³„"
    age: "ë‚˜ì´"
    height: "í‚¤"
    mass: "ì²´ì¤‘"
    date_of_birth: "ìƒë…„ì›”ì¼"
    handedness: "ì£¼ì†"

# ì²˜ë¦¬ ëŒ€ìƒ íŒŒì¼ í™•ì¥ì
file_extensions:
  - ".gt3x"
  - ".agd"

# ê¸°ë³¸ ì„¤ì •
defaults:
  year: 2025

# ë©”íƒ€ë°ì´í„° ìˆ˜ì • ì„¤ì •
metadata:
  # .agd íŒŒì¼ í•„ë“œëª… (SQLite settings í…Œì´ë¸”)
  agd_fields:
    subjectname: "subjectname"
    sex: "sex"
    height: "height"
    mass: "mass"
    age: "age"
    dateOfBirth: "dateOfBirth"
    side: "side"
    dominance: "dominance"
    limb: "limb"

  # .gt3x íŒŒì¼ í•„ë“œëª… (info.txt)
  gt3x_fields:
    subjectname: "Subject Name"
    sex: "Sex"
    height: "Height"
    mass: "Mass"
    age: "Age"
    dateOfBirth: "DateOfBirth"
    side: "Side"
    dominance: "Dominance"
    limb: "Limb"

  # ì„±ë³„ ë§¤í•‘
  sex_mapping:
    "ë‚¨": "Male"
    "ì—¬": "Female"

  # ì†ì¡ì´ ë§¤í•‘ (ì£¼ì†ì˜ ë°˜ëŒ€í¸ ì†ëª©ì— ì°©ìš©)
  handedness_mapping:
    "ì˜¤":  # ì˜¤ë¥¸ì†ì¡ì´ â†’ ì™¼ìª½ ì†ëª© ì°©ìš©
      side: "Left"
      dominance: "Dominant"
    "ì™¼":  # ì™¼ì†ì¡ì´ â†’ ì˜¤ë¥¸ìª½ ì†ëª© ì°©ìš©
      side: "Right"
      dominance: "Non-Dominant"

  # ê¸°ë³¸ê°’
  defaults:
    limb: "Waist"

```
</file>
<file path="modify.py">
```py
#!/usr/bin/env python3
"""
ActiGraph íŒŒì¼ ë©”íƒ€ë°ì´í„° ìˆ˜ì • ìŠ¤í¬ë¦½íŠ¸

.agd íŒŒì¼ (SQLite)ê³¼ .gt3x íŒŒì¼ (ZIP)ì˜ ë©”íƒ€ë°ì´í„°ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.

ì‚¬ìš© ì˜ˆì‹œ:
    # í…ŒìŠ¤íŠ¸ ëª¨ë“œ (Progress 02 ê²€ì¦ìš©)
    conda run -n module python modify.py --test

    # í”„ë¡œê·¸ë˜ë° ë°©ì‹ ì‚¬ìš© (Progress 04ì—ì„œ ì‚¬ìš©)
    from modify import ActiGraphModifier
    modifier = ActiGraphModifier()
    modifier.modify_agd_file(path, metadata)
"""

import argparse
import datetime
import os
import shutil
import sqlite3
import sys
import tempfile
import zipfile
from pathlib import Path
from typing import Dict, Optional, Tuple

import yaml


class ActiGraphModifier:
    """ActiGraph íŒŒì¼ (.agd, .gt3x) ë©”íƒ€ë°ì´í„° ìˆ˜ì • í´ë˜ìŠ¤"""

    def __init__(self, config_path: str = "config.yaml"):
        """ì„¤ì • íŒŒì¼ì„ ë¡œë“œí•˜ê³  ì´ˆê¸°í™”

        Args:
            config_path: config.yaml íŒŒì¼ ê²½ë¡œ
        """
        with open(config_path, 'r', encoding='utf-8') as f:
            self.config = yaml.safe_load(f)

    def datetime_to_ticks(self, dt: datetime.datetime) -> int:
        """datetimeì„ Windows DateTime.Ticksë¡œ ë³€í™˜

        Args:
            dt: ë³€í™˜í•  datetime ê°ì²´

        Returns:
            int: Ticks ê°’ (100ns ë‹¨ìœ„, 0001-01-01 ê¸°ì¤€)

        Example:
            >>> datetime.datetime(1999, 11, 1) -> 630770112000000000
        """
        base = datetime.datetime(1, 1, 1)
        delta = dt - base
        return int(delta.total_seconds() * 10_000_000)

    def ticks_to_datetime(self, ticks: int) -> datetime.datetime:
        """Windows DateTime.Ticksë¥¼ datetimeìœ¼ë¡œ ë³€í™˜

        Args:
            ticks: Ticks ê°’

        Returns:
            datetime: ë³€í™˜ëœ datetime ê°ì²´

        Example:
            >>> 630770112000000000 -> datetime.datetime(1999, 11, 1)
        """
        base = datetime.datetime(1, 1, 1)
        return base + datetime.timedelta(microseconds=int(ticks) / 10)

    def map_handedness(self, hand: str) -> Tuple[str, str]:
        """ì†ì¡ì´ ì •ë³´ë¥¼ side/dominanceë¡œ ë§¤í•‘

        ActiGraphëŠ” ì£¼ì†ì˜ ë°˜ëŒ€í¸ ì†ëª©ì— ì°©ìš©í•©ë‹ˆë‹¤.

        Args:
            hand: "ì˜¤" (ì˜¤ë¥¸ì†ì¡ì´) ë˜ëŠ” "ì™¼" (ì™¼ì†ì¡ì´)

        Returns:
            tuple: (side, dominance)

        Example:
            >>> "ì˜¤" -> ("Left", "Dominant")  # ì˜¤ë¥¸ì†ì¡ì´ëŠ” ì™¼ìª½ ì†ëª©
            >>> "ì™¼" -> ("Right", "Non-Dominant")  # ì™¼ì†ì¡ì´ëŠ” ì˜¤ë¥¸ìª½ ì†ëª©
        """
        mapping = self.config['metadata']['handedness_mapping']
        if hand not in mapping:
            raise ValueError(f"Unknown handedness: {hand}. Expected 'ì˜¤' or 'ì™¼'")

        return (mapping[hand]['side'], mapping[hand]['dominance'])

    def _create_backup(self, file_path: str) -> str:
        """íŒŒì¼ ë°±ì—… ìƒì„±

        Args:
            file_path: ë°±ì—…í•  íŒŒì¼ ê²½ë¡œ

        Returns:
            str: ë°±ì—… íŒŒì¼ ê²½ë¡œ
        """
        backup_path = f"{file_path}.bak"
        shutil.copy2(file_path, backup_path)
        return backup_path

    def _restore_backup(self, original_path: str, backup_path: str):
        """ë°±ì—…ì—ì„œ ë³µì›

        Args:
            original_path: ì›ë³¸ íŒŒì¼ ê²½ë¡œ
            backup_path: ë°±ì—… íŒŒì¼ ê²½ë¡œ
        """
        if os.path.exists(backup_path):
            shutil.copy2(backup_path, original_path)
            os.remove(backup_path)

    def modify_agd_file(self, file_path: str, metadata: Dict) -> bool:
        """.agd íŒŒì¼ (SQLite) ë©”íƒ€ë°ì´í„° ìˆ˜ì •

        Args:
            file_path: .agd íŒŒì¼ ê²½ë¡œ
            metadata: ìˆ˜ì •í•  ë©”íƒ€ë°ì´í„°
                - subjectname: str (ì´ë¦„)
                - sex: str ("Male" or "Female")
                - height: int (cm)
                - mass: int (kg)
                - age: int
                - dateOfBirth: datetime ë˜ëŠ” int (Ticks)
                - hand: str ("ì˜¤" or "ì™¼") - side/dominanceë¡œ ìë™ ë³€í™˜
                - limb: str (Optional, default "Waist")

        Returns:
            bool: ì„±ê³µ ì—¬ë¶€
        """
        backup_path = None
        try:
            # ë°±ì—… ìƒì„±
            backup_path = self._create_backup(file_path)

            # SQLite ì—°ê²°
            conn = sqlite3.connect(file_path)
            cursor = conn.cursor()

            # í•„ë“œ ë§¤í•‘
            field_mapping = self.config['metadata']['agd_fields']

            # ë©”íƒ€ë°ì´í„° ì¤€ë¹„
            updates = {}

            # ê¸°ë³¸ í•„ë“œ
            if 'subjectname' in metadata:
                updates[field_mapping['subjectname']] = str(metadata['subjectname'])

            if 'sex' in metadata:
                updates[field_mapping['sex']] = str(metadata['sex'])

            if 'height' in metadata:
                updates[field_mapping['height']] = str(metadata['height'])

            if 'mass' in metadata:
                updates[field_mapping['mass']] = str(metadata['mass'])

            if 'age' in metadata:
                updates[field_mapping['age']] = str(metadata['age'])

            # dateOfBirth ë³€í™˜
            if 'dateOfBirth' in metadata:
                dob = metadata['dateOfBirth']
                if isinstance(dob, datetime.datetime):
                    dob_ticks = self.datetime_to_ticks(dob)
                else:
                    dob_ticks = int(dob)
                updates[field_mapping['dateOfBirth']] = str(dob_ticks)

            # ì†ì¡ì´ ë§¤í•‘
            if 'hand' in metadata:
                side, dominance = self.map_handedness(metadata['hand'])
                updates[field_mapping['side']] = side
                updates[field_mapping['dominance']] = dominance

            # limb ê¸°ë³¸ê°’
            if 'limb' in metadata:
                updates[field_mapping['limb']] = str(metadata['limb'])
            else:
                default_limb = self.config['metadata']['defaults']['limb']
                updates[field_mapping['limb']] = default_limb

            # UPDATE ì‹¤í–‰
            for field_name, value in updates.items():
                cursor.execute(
                    "UPDATE settings SET settingValue=? WHERE settingName=?",
                    (value, field_name)
                )

            conn.commit()
            conn.close()

            # ë°±ì—… ì‚­ì œ
            if backup_path and os.path.exists(backup_path):
                os.remove(backup_path)

            return True

        except Exception as e:
            print(f"âŒ Error modifying .agd file: {e}")
            if backup_path:
                self._restore_backup(file_path, backup_path)
            return False

    def _parse_info_txt(self, content: str) -> Dict[str, str]:
        """info.txt ë‚´ìš© íŒŒì‹±

        Args:
            content: info.txt ë¬¸ìì—´

        Returns:
            dict: í‚¤-ê°’ ë”•ì…”ë„ˆë¦¬
        """
        info_dict = {}
        for line in content.strip().split('\n'):
            if ':' in line:
                key, value = line.split(':', 1)
                info_dict[key.strip()] = value.strip()
        return info_dict

    def _update_info_txt(self, content: str, metadata: Dict) -> str:
        """info.txt ë‚´ìš© ì—…ë°ì´íŠ¸

        ê¸°ì¡´ í•„ë“œë¥¼ ì—…ë°ì´íŠ¸í•˜ê³ , ì—†ëŠ” í•„ë“œëŠ” ì ì ˆí•œ ìœ„ì¹˜ì— ì¶”ê°€í•©ë‹ˆë‹¤.

        Args:
            content: ì›ë³¸ info.txt ë¬¸ìì—´
            metadata: ìˆ˜ì •í•  ë©”íƒ€ë°ì´í„°

        Returns:
            str: ì—…ë°ì´íŠ¸ëœ info.txt ë¬¸ìì—´
        """
        lines = content.strip().split('\n')
        field_mapping = self.config['metadata']['gt3x_fields']

        # ì—…ë°ì´íŠ¸í•  ê°’ ì¤€ë¹„
        updates = {}

        if 'subjectname' in metadata:
            updates[field_mapping['subjectname']] = str(metadata['subjectname'])

        if 'sex' in metadata:
            updates[field_mapping['sex']] = str(metadata['sex'])

        if 'height' in metadata:
            updates[field_mapping['height']] = str(metadata['height'])

        if 'mass' in metadata:
            updates[field_mapping['mass']] = str(metadata['mass'])

        if 'age' in metadata:
            updates[field_mapping['age']] = str(metadata['age'])

        if 'dateOfBirth' in metadata:
            dob = metadata['dateOfBirth']
            if isinstance(dob, datetime.datetime):
                dob_ticks = self.datetime_to_ticks(dob)
            else:
                dob_ticks = int(dob)
            updates[field_mapping['dateOfBirth']] = str(dob_ticks)

        if 'hand' in metadata:
            side, dominance = self.map_handedness(metadata['hand'])
            updates[field_mapping['side']] = side
            updates[field_mapping['dominance']] = dominance

        if 'limb' in metadata:
            updates[field_mapping['limb']] = str(metadata['limb'])
        else:
            default_limb = self.config['metadata']['defaults']['limb']
            updates[field_mapping['limb']] = default_limb

        # í˜„ì¬ ì¡´ì¬í•˜ëŠ” í•„ë“œ íŒŒì•…
        existing_keys = set()
        for line in lines:
            if ':' in line:
                key = line.split(':', 1)[0].strip()
                existing_keys.add(key)

        # ë¼ì¸ë³„ë¡œ ì—…ë°ì´íŠ¸ ë° ì‚½ì…
        updated_lines = []
        i = 0
        while i < len(lines):
            line = lines[i]

            if ':' in line:
                key = line.split(':', 1)[0].strip()

                # ê¸°ì¡´ í•„ë“œ ì—…ë°ì´íŠ¸
                if key in updates:
                    updated_lines.append(f"{key}: {updates[key]}")
                else:
                    updated_lines.append(line)

                # Sex, Height, Mass, AgeëŠ” "Acceleration Max" ë‹¤ìŒì— ì‚½ì…
                if key == "Acceleration Max":
                    for field_key in ['Sex', 'Height', 'Mass', 'Age']:
                        if field_key not in existing_keys and field_key in updates:
                            updated_lines.append(f"{field_key}: {updates[field_key]}")

                # DateOfBirthëŠ” "Dominance" ë‹¤ìŒì— ì‚½ì…
                if key == "Dominance":
                    if 'DateOfBirth' not in existing_keys and 'DateOfBirth' in updates:
                        updated_lines.append(f"DateOfBirth: {updates['DateOfBirth']}")

            else:
                updated_lines.append(line)

            i += 1

        return '\n'.join(updated_lines) + '\n'

    def modify_gt3x_file(self, file_path: str, metadata: Dict) -> bool:
        """.gt3x íŒŒì¼ (ZIP) ë©”íƒ€ë°ì´í„° ìˆ˜ì •

        info.txtë§Œ ìˆ˜ì •í•˜ê³  log.binì€ ìˆ˜ì •í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

        Args:
            file_path: .gt3x íŒŒì¼ ê²½ë¡œ
            metadata: ìˆ˜ì •í•  ë©”íƒ€ë°ì´í„° (modify_agd_fileê³¼ ë™ì¼)

        Returns:
            bool: ì„±ê³µ ì—¬ë¶€
        """
        backup_path = None
        try:
            # ë°±ì—… ìƒì„±
            backup_path = self._create_backup(file_path)

            # ì„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
            with tempfile.TemporaryDirectory() as temp_dir:
                temp_path = Path(temp_dir)

                # ZIP ì••ì¶• í•´ì œ
                with zipfile.ZipFile(file_path, 'r') as zf:
                    zf.extractall(temp_path)

                # info.txt ì½ê¸° ë° ìˆ˜ì •
                info_txt_path = temp_path / 'info.txt'
                if not info_txt_path.exists():
                    raise FileNotFoundError("info.txt not found in .gt3x file")

                with open(info_txt_path, 'r', encoding='utf-8') as f:
                    original_content = f.read()

                updated_content = self._update_info_txt(original_content, metadata)

                with open(info_txt_path, 'w', encoding='utf-8') as f:
                    f.write(updated_content)

                # ZIP ì¬ìƒì„±
                with zipfile.ZipFile(file_path, 'w', zipfile.ZIP_DEFLATED) as zf:
                    for file in temp_path.rglob('*'):
                        if file.is_file():
                            arcname = file.relative_to(temp_path)
                            zf.write(file, arcname)

            # ë°±ì—… ì‚­ì œ
            if backup_path and os.path.exists(backup_path):
                os.remove(backup_path)

            return True

        except Exception as e:
            print(f"âŒ Error modifying .gt3x file: {e}")
            if backup_path:
                self._restore_backup(file_path, backup_path)
            return False

    def validate_agd_modification(self, file_path: str, expected: Dict) -> bool:
        """.agd íŒŒì¼ ìˆ˜ì • ê²€ì¦

        Args:
            file_path: ê²€ì¦í•  .agd íŒŒì¼ ê²½ë¡œ
            expected: ì˜ˆìƒë˜ëŠ” ë©”íƒ€ë°ì´í„° ê°’

        Returns:
            bool: ëª¨ë“  í•„ë“œê°€ ì˜ˆìƒê°’ê³¼ ì¼ì¹˜í•˜ë©´ True
        """
        try:
            conn = sqlite3.connect(file_path)
            settings = dict(
                conn.execute("SELECT settingName, settingValue FROM settings").fetchall()
            )
            conn.close()

            field_mapping = self.config['metadata']['agd_fields']

            for key, expected_value in expected.items():
                field_name = field_mapping.get(key)
                if field_name is None:
                    continue

                actual_value = settings.get(field_name, '')

                # dateOfBirthëŠ” Ticksë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ
                if key == 'dateOfBirth':
                    if isinstance(expected_value, datetime.datetime):
                        expected_value = str(self.datetime_to_ticks(expected_value))
                    else:
                        expected_value = str(expected_value)
                else:
                    expected_value = str(expected_value)

                if actual_value != expected_value:
                    print(f"  âŒ Mismatch in {key}: expected '{expected_value}', got '{actual_value}'")
                    return False

            return True

        except Exception as e:
            print(f"âŒ Error validating .agd file: {e}")
            return False

    def validate_gt3x_modification(self, file_path: str, expected: Dict) -> bool:
        """.gt3x íŒŒì¼ ìˆ˜ì • ê²€ì¦

        Args:
            file_path: ê²€ì¦í•  .gt3x íŒŒì¼ ê²½ë¡œ
            expected: ì˜ˆìƒë˜ëŠ” ë©”íƒ€ë°ì´í„° ê°’

        Returns:
            bool: ëª¨ë“  í•„ë“œê°€ ì˜ˆìƒê°’ê³¼ ì¼ì¹˜í•˜ë©´ True
        """
        try:
            with zipfile.ZipFile(file_path, 'r') as zf:
                info_content = zf.read('info.txt').decode('utf-8')

            info_dict = self._parse_info_txt(info_content)
            field_mapping = self.config['metadata']['gt3x_fields']

            for key, expected_value in expected.items():
                field_name = field_mapping.get(key)
                if field_name is None:
                    continue

                actual_value = info_dict.get(field_name, '')

                # dateOfBirthëŠ” Ticksë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ
                if key == 'dateOfBirth':
                    if isinstance(expected_value, datetime.datetime):
                        expected_value = str(self.datetime_to_ticks(expected_value))
                    else:
                        expected_value = str(expected_value)
                else:
                    expected_value = str(expected_value)

                if actual_value != expected_value:
                    print(f"  âŒ Mismatch in {key}: expected '{expected_value}', got '{actual_value}'")
                    return False

            return True

        except Exception as e:
            print(f"âŒ Error validating .gt3x file: {e}")
            return False


def test_modifier():
    """Progress 02 ê²€ì¦ìš© í…ŒìŠ¤íŠ¸ í•¨ìˆ˜

    ì¡°ë¯¼ì„ ëŒ€ìƒì ë°ì´í„°ë¡œ original íŒŒì¼ì„ ìˆ˜ì •í•˜ì—¬
    modified íŒŒì¼ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤.
    """
    print("="*80)
    print("Progress 02: ActiGraph íŒŒì¼ ìˆ˜ì • í…ŒìŠ¤íŠ¸")
    print("="*80)

    # ì´ˆê¸°í™”
    modifier = ActiGraphModifier()

    # ì¡°ë¯¼ì„ ëŒ€ìƒì ë©”íƒ€ë°ì´í„°
    metadata = {
        'subjectname': 'ì¡°ë¯¼ì„',
        'sex': 'Male',
        'height': 177,
        'mass': 70,
        'age': 26,
        'dateOfBirth': datetime.datetime(1999, 11, 1),
        'hand': 'ì˜¤',  # ì˜¤ë¥¸ì†ì¡ì´
        'limb': 'Waist'
    }

    print("\nğŸ“‹ í…ŒìŠ¤íŠ¸ ë©”íƒ€ë°ì´í„°:")
    for key, value in metadata.items():
        print(f"  {key}: {value}")

    # íŒŒì¼ ê²½ë¡œ
    base_dir = Path("Archive")
    original_agd = base_dir / "original_MOS2A50130052 (2025-12-02)60sec.agd"
    original_gt3x = base_dir / "original_MOS2A50130052 (2025-12-02)60sec.gt3x"

    # í…ŒìŠ¤íŠ¸ìš© ì„ì‹œ íŒŒì¼ ìƒì„±
    temp_dir = Path("temp_test")
    temp_dir.mkdir(exist_ok=True)

    test_agd = temp_dir / "test.agd"
    test_gt3x = temp_dir / "test.gt3x"

    try:
        # .agd íŒŒì¼ í…ŒìŠ¤íŠ¸
        print("\n" + "="*80)
        print("í…ŒìŠ¤íŠ¸ 1: .agd íŒŒì¼ ìˆ˜ì •")
        print("="*80)

        shutil.copy2(original_agd, test_agd)
        print(f"âœ“ ì›ë³¸ íŒŒì¼ ë³µì‚¬: {original_agd.name}")

        success = modifier.modify_agd_file(str(test_agd), metadata)
        if success:
            print("âœ“ .agd íŒŒì¼ ìˆ˜ì • ì™„ë£Œ")
        else:
            print("âŒ .agd íŒŒì¼ ìˆ˜ì • ì‹¤íŒ¨")
            return

        # ê²€ì¦
        expected = {
            'subjectname': 'ì¡°ë¯¼ì„',
            'sex': 'Male',
            'height': 177,
            'mass': 70,
            'age': 26,
            'dateOfBirth': datetime.datetime(1999, 11, 1),
            'side': 'Left',
            'dominance': 'Dominant',
            'limb': 'Waist'
        }

        print("\nê²€ì¦ ì¤‘...")
        if modifier.validate_agd_modification(str(test_agd), expected):
            print("âœ… .agd íŒŒì¼ ê²€ì¦ ì„±ê³µ! ëª¨ë“  í•„ë“œê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.")
        else:
            print("âŒ .agd íŒŒì¼ ê²€ì¦ ì‹¤íŒ¨")
            return

        # .gt3x íŒŒì¼ í…ŒìŠ¤íŠ¸
        print("\n" + "="*80)
        print("í…ŒìŠ¤íŠ¸ 2: .gt3x íŒŒì¼ ìˆ˜ì •")
        print("="*80)

        shutil.copy2(original_gt3x, test_gt3x)
        print(f"âœ“ ì›ë³¸ íŒŒì¼ ë³µì‚¬: {original_gt3x.name}")

        success = modifier.modify_gt3x_file(str(test_gt3x), metadata)
        if success:
            print("âœ“ .gt3x íŒŒì¼ ìˆ˜ì • ì™„ë£Œ")
        else:
            print("âŒ .gt3x íŒŒì¼ ìˆ˜ì • ì‹¤íŒ¨")
            return

        # ê²€ì¦
        print("\nê²€ì¦ ì¤‘...")
        if modifier.validate_gt3x_modification(str(test_gt3x), expected):
            print("âœ… .gt3x íŒŒì¼ ê²€ì¦ ì„±ê³µ! ëª¨ë“  í•„ë“œê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.")
        else:
            print("âŒ .gt3x íŒŒì¼ ê²€ì¦ ì‹¤íŒ¨")
            return

        # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
        print("\n" + "="*80)
        print("í…ŒìŠ¤íŠ¸ 3: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸")
        print("="*80)

        # Ticks ë³€í™˜ í…ŒìŠ¤íŠ¸
        dt = datetime.datetime(1999, 11, 1)
        ticks = modifier.datetime_to_ticks(dt)
        expected_ticks = 630770112000000000

        print(f"\nTicks ë³€í™˜ í…ŒìŠ¤íŠ¸:")
        print(f"  ì…ë ¥: {dt}")
        print(f"  ì¶œë ¥: {ticks}")
        print(f"  ì˜ˆìƒ: {expected_ticks}")

        if ticks == expected_ticks:
            print("  âœ… Ticks ë³€í™˜ ì •í™•")
        else:
            print("  âŒ Ticks ë³€í™˜ ì˜¤ë¥˜")
            return

        # ì—­ë³€í™˜ í…ŒìŠ¤íŠ¸
        dt_back = modifier.ticks_to_datetime(ticks)
        print(f"\nì—­ë³€í™˜ í…ŒìŠ¤íŠ¸:")
        print(f"  ì…ë ¥: {ticks}")
        print(f"  ì¶œë ¥: {dt_back}")

        if dt_back == dt:
            print("  âœ… ì—­ë³€í™˜ ì •í™• (bidirectional)")
        else:
            print("  âŒ ì—­ë³€í™˜ ì˜¤ë¥˜")
            return

        # ì†ì¡ì´ ë§¤í•‘ í…ŒìŠ¤íŠ¸
        print(f"\nì†ì¡ì´ ë§¤í•‘ í…ŒìŠ¤íŠ¸:")
        side_r, dom_r = modifier.map_handedness('ì˜¤')
        print(f"  ì˜¤ë¥¸ì†ì¡ì´ ('ì˜¤'): side={side_r}, dominance={dom_r}")

        if side_r == 'Left' and dom_r == 'Dominant':
            print("  âœ… ì˜¤ë¥¸ì†ì¡ì´ ë§¤í•‘ ì •í™•")
        else:
            print("  âŒ ì˜¤ë¥¸ì†ì¡ì´ ë§¤í•‘ ì˜¤ë¥˜")
            return

        side_l, dom_l = modifier.map_handedness('ì™¼')
        print(f"  ì™¼ì†ì¡ì´ ('ì™¼'): side={side_l}, dominance={dom_l}")

        if side_l == 'Right' and dom_l == 'Non-Dominant':
            print("  âœ… ì™¼ì†ì¡ì´ ë§¤í•‘ ì •í™•")
        else:
            print("  âŒ ì™¼ì†ì¡ì´ ë§¤í•‘ ì˜¤ë¥˜")
            return

        # ì „ì²´ ì„±ê³µ
        print("\n" + "="*80)
        print("ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!")
        print("="*80)
        print("\nâœ… Progress 02 ì™„ë£Œ:")
        print("  - .agd íŒŒì¼ ìˆ˜ì • ë° ê²€ì¦ ì„±ê³µ")
        print("  - .gt3x íŒŒì¼ ìˆ˜ì • ë° ê²€ì¦ ì„±ê³µ")
        print("  - ëª¨ë“  ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ í†µê³¼")
        print("\nğŸ“ í…ŒìŠ¤íŠ¸ íŒŒì¼ ìœ„ì¹˜:")
        print(f"  {test_agd}")
        print(f"  {test_gt3x}")
        print("\në‹¤ìŒ: ActiLifeì—ì„œ íŒŒì¼ì„ ì—´ì–´ ìˆ˜ë™ ê²€ì¦í•˜ì„¸ìš”.")

    finally:
        # ì •ë¦¬ëŠ” í•˜ì§€ ì•ŠìŒ (ìˆ˜ë™ ê²€ì¦ìš©)
        pass


def main():
    parser = argparse.ArgumentParser(
        description="ActiGraph íŒŒì¼ ë©”íƒ€ë°ì´í„° ìˆ˜ì •",
        formatter_class=argparse.RawDescriptionHelpFormatter
    )

    parser.add_argument(
        '--test',
        action='store_true',
        help='Progress 02 ê²€ì¦ í…ŒìŠ¤íŠ¸ ì‹¤í–‰'
    )

    args = parser.parse_args()

    if args.test:
        test_modifier()
    else:
        print("ì‚¬ìš©ë²•: python modify.py --test")
        print("\nProgress 04ì—ì„œëŠ” í”„ë¡œê·¸ë˜ë° ë°©ì‹ìœ¼ë¡œ importí•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.")
        sys.exit(1)


if __name__ == '__main__':
    main()

```
</file>
<file path="name.py">
```py
#!/usr/bin/env python3
"""
ActiGraph íŒŒì¼ ìë™ ì´ë¦„ ë³€ê²½ ìŠ¤í¬ë¦½íŠ¸

íŒŒì¼ëª… í˜•ì‹:
  ê¸°ì¡´: ê³ ìœ ë²ˆí˜¸ (ë‚ ì§œ).í™•ì¥ì
  ë³€ê²½: ID_ì´ë¦„ (ë‚ ì§œ).í™•ì¥ì

ê¸°ë³¸ ì‚¬ìš© (2025ë…„ ê¸°ë³¸ê°’)
conda run -n module python name.py --week 40ì£¼ì°¨

ë¯¸ë¦¬ë³´ê¸° ëª¨ë“œ
conda run -n module python name.py --week 40ì£¼ì°¨ --dry
"""

import argparse
import datetime
import os
import re
import sys
from pathlib import Path
from typing import Dict, Optional, Tuple

import pandas as pd
import yaml

from modify import ActiGraphModifier


class ActiGraphRenamer:
    def __init__(self, config_path: str = "config.yaml"):
        """ì„¤ì • íŒŒì¼ì„ ë¡œë“œí•˜ê³  ì´ˆê¸°í™”"""
        with open(config_path, 'r', encoding='utf-8') as f:
            self.config = yaml.safe_load(f)
        
        self.serial_mapping_df = None
        self.subject_info_df = None
        
    def load_data(self, year: int):
        """Excel íŒŒì¼ì—ì„œ ë°ì´í„° ë¡œë“œ"""
        print("ğŸ“‚ ë°ì´í„° ë¡œë“œ ì¤‘...")

        # ê´€ë¦¬ë²ˆí˜¸-ì‹œë¦¬ì–¼ë²ˆí˜¸ ë§¤ì¹­ ë°ì´í„°
        serial_path = self.config['paths']['serial_mapping']
        self.serial_mapping_df = pd.read_excel(serial_path)
        print(f"  âœ“ ê´€ë¦¬ë²ˆí˜¸-ì‹œë¦¬ì–¼ë²ˆí˜¸ ë§¤ì¹­: {len(self.serial_mapping_df)} ê±´")

        # ëŒ€ìƒì ì •ë³´ ë°ì´í„° (ì—°ë„ë³„ ì‹œíŠ¸)
        subject_path = self.config['paths']['subject_info']
        self.subject_info_df = pd.read_excel(subject_path, sheet_name=str(year))

        # ì²« ë²ˆì§¸ í–‰ ì œê±° (ì¤‘ë³µ í—¤ë” í–‰)
        if len(self.subject_info_df) > 0 and pd.isna(self.subject_info_df.iloc[0]['ê´€ë¦¬ë²ˆí˜¸']):
            self.subject_info_df = self.subject_info_df.iloc[1:].reset_index(drop=True)

        # êµ¬ë¶„ ì»¬ëŸ¼ forward-fill (Excelì˜ ë³‘í•©ëœ ì…€ ì²˜ë¦¬)
        col_div = self.config['columns']['subject_info']['division']
        self.subject_info_df[col_div] = self.subject_info_df[col_div].ffill()

        print(f"  âœ“ ëŒ€ìƒì ì •ë³´ ({year}ë…„): {len(self.subject_info_df)} ê±´")
        
    def extract_serial_from_filename(self, filename: str) -> Optional[str]:
        """íŒŒì¼ëª…ì—ì„œ ê³ ìœ ë²ˆí˜¸ ì¶”ì¶œ
        
        ì˜ˆ: "MOS2D36155148 (2025-11-13).gt3x" -> "MOS2D36155148"
        """
        match = re.match(r'^([A-Z0-9]+)\s*\(', filename)
        if match:
            return match.group(1)
        return None
    
    def extract_info_from_renamed_file(self, filename: str) -> Optional[Tuple[str, str, str]]:
        """ì´ë¯¸ ë³€ê²½ëœ íŒŒì¼ëª…ì—ì„œ ID, ì´ë¦„, ë‚ ì§œ ì¶”ì¶œ
        
        ì˜ˆ: "JB54017302_ê¹€ì„ ì˜¥ (2025-11-08).gt3x" -> ("JB54017302", "ê¹€ì„ ì˜¥", "2025-11-08")
        """
        match = re.match(r'^([A-Z0-9]+)_([ê°€-í£]+)\s*\((\d{4}-\d{2}-\d{2})\)', filename)
        if match:
            return (match.group(1), match.group(2), match.group(3))
        return None
    
    def get_management_number(self, serial_number: str) -> Optional[int]:
        """ê³ ìœ ë²ˆí˜¸ë¡œ ê´€ë¦¬ë²ˆí˜¸ ì¡°íšŒ"""
        col_serial = self.config['columns']['serial_mapping']['serial_number']
        col_mgmt = self.config['columns']['serial_mapping']['management_number']
        
        result = self.serial_mapping_df[
            self.serial_mapping_df[col_serial] == serial_number
        ]
        
        if len(result) == 0:
            return None
        
        return int(result.iloc[0][col_mgmt])
    
    def get_subject_info(self, management_number: int, division: str) -> Optional[Tuple[str, str, str]]:
        """ê´€ë¦¬ë²ˆí˜¸ì™€ êµ¬ë¶„ìœ¼ë¡œ ëŒ€ìƒì ID, ì´ë¦„, ì°©ìš©ì‹œì‘ì¼ ì¡°íšŒ
        
        Returns:
            (ID, ì´ë¦„, ì°©ìš©ì‹œì‘ì¼) íŠœí”Œ ë˜ëŠ” None
        """
        col_mgmt = self.config['columns']['subject_info']['management_number']
        col_div = self.config['columns']['subject_info']['division']
        col_id = self.config['columns']['subject_info']['id']
        col_name = self.config['columns']['subject_info']['name']
        col_wear_date = self.config['columns']['subject_info']['wear_start_date']
        
        result = self.subject_info_df[
            (self.subject_info_df[col_mgmt] == management_number) &
            (self.subject_info_df[col_div] == division)
        ]
        
        if len(result) == 0:
            return None
        
        if len(result) > 1:
            print(f"  âš ï¸  ê²½ê³ : ê´€ë¦¬ë²ˆí˜¸ {management_number}, êµ¬ë¶„ {division}ì— {len(result)}ê°œì˜ ë§¤ì¹­ ë°œê²¬")
        
        subject_id = str(result.iloc[0][col_id])
        subject_name = str(result.iloc[0][col_name])
        wear_start_date = result.iloc[0][col_wear_date]
        
        # ë‚ ì§œ í˜•ì‹ ë³€í™˜
        try:
            wear_date_str = pd.to_datetime(wear_start_date).strftime('%Y-%m-%d')
        except Exception as e:
            print(f"  âš ï¸  ê²½ê³ : ì°©ìš© ì‹œì‘ì¼ ë³€í™˜ ì‹¤íŒ¨ ({wear_start_date}): {e}")
            return None
        
        return (subject_id, subject_name, wear_date_str)

    def parse_date_from_excel(self, date_value) -> Optional[datetime.datetime]:
        """Excel ë‚ ì§œ íŒŒì‹± (MM-DD-YY í˜•ì‹)

        Args:
            date_value: Excel ë‚ ì§œ ê°’ (pandas datetime ë˜ëŠ” ë¬¸ìì—´ "MM-DD-YY")

        Returns:
            datetime ê°ì²´ ë˜ëŠ” None

        Example:
            "01-16-78" -> datetime(1978, 1, 16)
            "02-22-03" -> datetime(2003, 2, 22)

        Note:
            YY < 50 -> 20YY (2000ë…„ëŒ€)
            YY >= 50 -> 19YY (1900ë…„ëŒ€)
        """
        try:
            # pandas Timestampì¸ ê²½ìš°
            if isinstance(date_value, pd.Timestamp):
                return date_value.to_pydatetime()

            # datetimeì¸ ê²½ìš°
            if isinstance(date_value, datetime.datetime):
                return date_value

            # ë¬¸ìì—´ì¸ ê²½ìš° (MM-DD-YY)
            date_str = str(date_value).strip()

            # MM-DD-YY í˜•ì‹ íŒŒì‹±
            parts = date_str.split('-')
            if len(parts) != 3:
                print(f"  âš ï¸  ê²½ê³ : ë‚ ì§œ í˜•ì‹ ì˜¤ë¥˜ ({date_str}), MM-DD-YY í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤")
                return None

            month, day, year = int(parts[0]), int(parts[1]), int(parts[2])

            # 2ìë¦¬ ì—°ë„ë¥¼ 4ìë¦¬ë¡œ ë³€í™˜
            if year < 50:
                year += 2000
            else:
                year += 1900

            return datetime.datetime(year, month, day)

        except Exception as e:
            print(f"  âš ï¸  ê²½ê³ : ë‚ ì§œ íŒŒì‹± ì‹¤íŒ¨ ({date_value}): {e}")
            return None

    def extract_metadata_from_subject_info(self, management_number: int, division: str) -> Optional[Dict]:
        """Excelì—ì„œ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ

        Args:
            management_number: ê´€ë¦¬ë²ˆí˜¸
            division: êµ¬ë¶„ (ì˜ˆ: "40ì£¼ì°¨")

        Returns:
            ë©”íƒ€ë°ì´í„° dict ë˜ëŠ” None
            {
                'subjectname': str,
                'sex': str,  # "Male" or "Female"
                'height': int,
                'mass': int,
                'age': int,
                'dateOfBirth': datetime,
                'hand': str,  # "ì˜¤" or "ì™¼"
                'limb': str   # "Waist"
            }
        """
        col_mgmt = self.config['columns']['subject_info']['management_number']
        col_div = self.config['columns']['subject_info']['division']
        col_name = self.config['columns']['subject_info']['name']
        col_sex = self.config['columns']['subject_info']['sex']
        col_age = self.config['columns']['subject_info']['age']
        col_height = self.config['columns']['subject_info']['height']
        col_mass = self.config['columns']['subject_info']['mass']
        col_dob = self.config['columns']['subject_info']['date_of_birth']
        col_hand = self.config['columns']['subject_info']['handedness']

        # Excelì—ì„œ í–‰ ì¡°íšŒ
        result = self.subject_info_df[
            (self.subject_info_df[col_mgmt] == management_number) &
            (self.subject_info_df[col_div] == division)
        ]

        if len(result) == 0:
            return None

        row = result.iloc[0]

        # ìƒë…„ì›”ì¼ íŒŒì‹±
        dob = self.parse_date_from_excel(row[col_dob])
        if dob is None:
            print(f"  âš ï¸  ê²½ê³ : ìƒë…„ì›”ì¼ íŒŒì‹± ì‹¤íŒ¨ (ê´€ë¦¬ë²ˆí˜¸: {management_number})")
            return None

        # ì„±ë³„ ë§¤í•‘
        sex_raw = str(row[col_sex]).strip()
        sex_mapping = self.config['metadata']['sex_mapping']
        sex = sex_mapping.get(sex_raw, sex_raw)

        # ë©”íƒ€ë°ì´í„° êµ¬ì„±
        metadata = {
            'subjectname': str(row[col_name]),
            'sex': sex,
            'height': int(row[col_height]),
            'mass': int(row[col_mass]),
            'age': int(row[col_age]),
            'dateOfBirth': dob,
            'hand': str(row[col_hand]).strip(),
            'limb': 'Waist'
        }

        return metadata

    def generate_new_filename(self, old_filename: str, subject_id: str, name: str, wear_date: str) -> str:
        """ìƒˆ íŒŒì¼ëª… ìƒì„±
        
        ì˜ˆ: "MOS2D36155148 (2025-11-13).gt3x" + "JB54017302" + "ê¹€ì„ ì˜¥" + "2025-11-08"
            -> "JB54017302_ê¹€ì„ ì˜¥ (2025-11-08).gt3x"
        ì˜ˆ: "JB54017302_ê¹€ì„ ì˜¥ (2025-11-13)60sec.agd" + "JB54017302" + "ê¹€ì„ ì˜¥" + "2025-11-08"
            -> "JB54017302_ê¹€ì„ ì˜¥ (2025-11-08)60sec.agd"
        """
        # ì›ë³¸ í˜•ì‹: ê³ ìœ ë²ˆí˜¸ (ë‚ ì§œ).í™•ì¥ì
        match1 = re.match(r'^[A-Z0-9]+\s*\([^)]+\)(.*)$', old_filename)
        if match1:
            suffix = match1.group(1)
            return f"{subject_id}_{name} ({wear_date}){suffix}"
        
        # ì´ë¯¸ ë³€ê²½ëœ í˜•ì‹: ID_ì´ë¦„ (ë‚ ì§œ).í™•ì¥ì
        match2 = re.match(r'^[A-Z0-9]+_[ê°€-í£]+\s*\([^)]+\)(.*)$', old_filename)
        if match2:
            suffix = match2.group(1)
            return f"{subject_id}_{name} ({wear_date}){suffix}"
        
        return old_filename
    
    def process_file(self, filepath: Path, division: str, dry_run: bool = False, modify_metadata: bool = True) -> Tuple[bool, str]:
        """ë‹¨ì¼ íŒŒì¼ ì²˜ë¦¬

        Args:
            filepath: ì²˜ë¦¬í•  íŒŒì¼ ê²½ë¡œ
            division: êµ¬ë¶„ (ì˜ˆ: "40ì£¼ì°¨")
            dry_run: Trueì´ë©´ ì‹¤ì œ ë³€ê²½ ì—†ì´ ë¯¸ë¦¬ë³´ê¸°ë§Œ
            modify_metadata: Trueì´ë©´ ë©”íƒ€ë°ì´í„°ë„ ìˆ˜ì •, Falseì´ë©´ íŒŒì¼ëª…ë§Œ ë³€ê²½

        Returns:
            (ì„±ê³µ ì—¬ë¶€, ë©”ì‹œì§€)
        """
        filename = filepath.name
        
        # ì´ë¯¸ ë³€ê²½ëœ íŒŒì¼ì¸ì§€ í™•ì¸
        renamed_info = self.extract_info_from_renamed_file(filename)
        
        # ê³ ìœ ë²ˆí˜¸ ì¶”ì¶œ (ì›ë³¸ íŒŒì¼ ë˜ëŠ” ë³€ê²½ëœ íŒŒì¼)
        if renamed_info:
            # ì´ë¯¸ ë³€ê²½ëœ íŒŒì¼ - IDë¡œ ê´€ë¦¬ë²ˆí˜¸ ì—­ì¶”ì 
            existing_id, existing_name, existing_date = renamed_info
            
            # IDë¡œ ê´€ë¦¬ë²ˆí˜¸ ì°¾ê¸° (ì—­ì¡°íšŒ)
            col_id = self.config['columns']['subject_info']['id']
            col_mgmt = self.config['columns']['subject_info']['management_number']
            col_div = self.config['columns']['subject_info']['division']
            
            result = self.subject_info_df[
                (self.subject_info_df[col_id] == existing_id) &
                (self.subject_info_df[col_div] == division)
            ]
            
            if len(result) == 0:
                return False, f"ID {existing_id}ì— ëŒ€í•œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            
            management_number = int(result.iloc[0][col_mgmt])
        else:
            # ì›ë³¸ íŒŒì¼ - ê³ ìœ ë²ˆí˜¸ì—ì„œ ê´€ë¦¬ë²ˆí˜¸ ì°¾ê¸°
            serial_number = self.extract_serial_from_filename(filename)
            if not serial_number:
                return False, "ê³ ìœ ë²ˆí˜¸ ì¶”ì¶œ ì‹¤íŒ¨"
            
            # ê´€ë¦¬ë²ˆí˜¸ ì¡°íšŒ
            management_number = self.get_management_number(serial_number)
            if management_number is None:
                return False, f"ê´€ë¦¬ë²ˆí˜¸ ì°¾ì„ ìˆ˜ ì—†ìŒ (ê³ ìœ ë²ˆí˜¸: {serial_number})"
        
        # ID, ì´ë¦„, ì°©ìš©ì‹œì‘ì¼ ì¡°íšŒ
        subject_info = self.get_subject_info(management_number, division)
        if subject_info is None:
            return False, f"ëŒ€ìƒì ì •ë³´ ì°¾ì„ ìˆ˜ ì—†ìŒ (ê´€ë¦¬ë²ˆí˜¸: {management_number}, êµ¬ë¶„: {division})"
        
        subject_id, name, wear_date = subject_info
        
        # ìƒˆ íŒŒì¼ëª… ìƒì„±
        new_filename = self.generate_new_filename(filename, subject_id, name, wear_date)
        
        # ì´ë¯¸ ì˜¬ë°”ë¥¸ íŒŒì¼ëª…ì¸ ê²½ìš° ê±´ë„ˆë›°ê¸°
        if renamed_info:
            existing_id, existing_name, existing_date = renamed_info
            if existing_id == subject_id and existing_name == name and existing_date == wear_date:
                return False, "ì´ë¯¸ ì˜¬ë°”ë¥´ê²Œ ë³€ê²½ë¨"
        
        new_filepath = filepath.parent / new_filename

        # ë©”íƒ€ë°ì´í„° ìˆ˜ì • (íŒŒì¼ëª… ë³€ê²½ ì „)
        if modify_metadata and not dry_run:
            # ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
            metadata = self.extract_metadata_from_subject_info(management_number, division)
            if metadata is None:
                return False, f"ë©”íƒ€ë°ì´í„° ì¶”ì¶œ ì‹¤íŒ¨ (ê´€ë¦¬ë²ˆí˜¸: {management_number}, êµ¬ë¶„: {division})"

            try:
                # ActiGraphModifier ì´ˆê¸°í™”
                modifier = ActiGraphModifier(self.config.get('config_path', 'config.yaml') if isinstance(self.config, dict) else 'config.yaml')

                # .agd ë˜ëŠ” .gt3x íŒŒì¼ ë©”íƒ€ë°ì´í„° ìˆ˜ì •
                file_ext = filepath.suffix.lower()
                if file_ext == '.agd':
                    success = modifier.modify_agd_file(str(filepath), metadata)
                    if not success:
                        return False, f"ë©”íƒ€ë°ì´í„° ìˆ˜ì • ì‹¤íŒ¨ (.agd): {filename}"
                elif file_ext == '.gt3x':
                    success = modifier.modify_gt3x_file(str(filepath), metadata)
                    if not success:
                        return False, f"ë©”íƒ€ë°ì´í„° ìˆ˜ì • ì‹¤íŒ¨ (.gt3x): {filename}"

                # ê²€ì¦
                expected = {
                    'subjectname': metadata['subjectname'],
                    'sex': metadata['sex'],
                    'height': metadata['height'],
                    'mass': metadata['mass'],
                    'age': metadata['age'],
                    'dateOfBirth': metadata['dateOfBirth'],
                    'side': modifier.map_handedness(metadata['hand'])[0],
                    'dominance': modifier.map_handedness(metadata['hand'])[1],
                    'limb': metadata['limb']
                }

                if file_ext == '.agd':
                    if not modifier.validate_agd_modification(str(filepath), expected):
                        return False, f"ë©”íƒ€ë°ì´í„° ê²€ì¦ ì‹¤íŒ¨ (.agd): {filename}"
                elif file_ext == '.gt3x':
                    if not modifier.validate_gt3x_modification(str(filepath), expected):
                        return False, f"ë©”íƒ€ë°ì´í„° ê²€ì¦ ì‹¤íŒ¨ (.gt3x): {filename}"

            except Exception as e:
                return False, f"ë©”íƒ€ë°ì´í„° ìˆ˜ì • ì¤‘ ì˜¤ë¥˜: {str(e)}"

        # íŒŒì¼ ë³€ê²½
        if not dry_run:
            try:
                filepath.rename(new_filepath)
                if modify_metadata:
                    return True, f"ë³€ê²½ ì™„ë£Œ (ë©”íƒ€ë°ì´í„° + íŒŒì¼ëª…): {filename} -> {new_filename}"
                else:
                    return True, f"ë³€ê²½ ì™„ë£Œ (íŒŒì¼ëª…ë§Œ): {filename} -> {new_filename}"
            except Exception as e:
                return False, f"íŒŒì¼ ë³€ê²½ ì‹¤íŒ¨: {str(e)}"
        else:
            if modify_metadata:
                return True, f"[DRY-RUN] ë©”íƒ€ë°ì´í„° + íŒŒì¼ëª…: {filename} -> {new_filename}"
            else:
                return True, f"[DRY-RUN] íŒŒì¼ëª…ë§Œ: {filename} -> {new_filename}"
    
    def run(self, division: str, year: int = None, dry_run: bool = False, modify_metadata: bool = True):
        """ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰

        Args:
            division: êµ¬ë¶„ (ì˜ˆ: "40ì£¼ì°¨")
            year: ì—°ë„ (ê¸°ë³¸ê°’: config.yamlì˜ defaults.year)
            dry_run: Trueì´ë©´ ì‹¤ì œ ë³€ê²½ ì—†ì´ ë¯¸ë¦¬ë³´ê¸°ë§Œ
            modify_metadata: Trueì´ë©´ ë©”íƒ€ë°ì´í„°ë„ ìˆ˜ì •, Falseì´ë©´ íŒŒì¼ëª…ë§Œ ë³€ê²½
        """
        if year is None:
            year = self.config['defaults']['year']

        print(f"\n{'='*60}")
        print(f"ActiGraph íŒŒì¼ ìë™ ì´ë¦„ ë³€ê²½")
        print(f"{'='*60}")
        print(f"ğŸ“… ì—°ë„: {year}")
        print(f"ğŸ“Œ êµ¬ë¶„: {division}")
        print(f"ğŸ” ëª¨ë“œ: {'DRY-RUN (ë¯¸ë¦¬ë³´ê¸°)' if dry_run else 'ì‹¤ì œ ë³€ê²½'}")
        print(f"ğŸ“ ë©”íƒ€ë°ì´í„° ìˆ˜ì •: {'ì˜ˆ' if modify_metadata else 'ì•„ë‹ˆì˜¤ (íŒŒì¼ëª…ë§Œ)'}")
        print(f"{'='*60}\n")
        
        # ë°ì´í„° ë¡œë“œ
        self.load_data(year)
        
        # ëŒ€ìƒ ë””ë ‰í† ë¦¬
        target_dir = Path(self.config['paths']['target_directory'])
        if not target_dir.exists():
            print(f"âŒ ì˜¤ë¥˜: ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {target_dir}")
            return
        
        # ì²˜ë¦¬ ëŒ€ìƒ íŒŒì¼ ì°¾ê¸°
        extensions = self.config['file_extensions']
        files = []
        for ext in extensions:
            files.extend(target_dir.glob(f"*{ext}"))
        
        if not files:
            print(f"âŒ ì²˜ë¦¬í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. (í™•ì¥ì: {', '.join(extensions)})")
            return
        
        print(f"ğŸ“ ë°œê²¬ëœ íŒŒì¼: {len(files)}ê°œ\n")
        
        # íŒŒì¼ ì²˜ë¦¬
        success_count = 0
        skip_count = 0
        error_count = 0
        
        for filepath in sorted(files):
            success, message = self.process_file(filepath, division, dry_run, modify_metadata)

            if success:
                print(f"âœ… {message}")
                success_count += 1
            else:
                if "ì´ë¯¸ ë³€ê²½ë¨" in message:
                    print(f"â­ï¸  {filepath.name}: {message}")
                    skip_count += 1
                else:
                    print(f"âŒ {filepath.name}: {message}")
                    error_count += 1
        
        # ê²°ê³¼ ìš”ì•½
        print(f"\n{'='*60}")
        print(f"ğŸ“Š ì²˜ë¦¬ ê²°ê³¼")
        print(f"{'='*60}")
        print(f"âœ… ì„±ê³µ: {success_count}ê°œ")
        print(f"â­ï¸  ê±´ë„ˆëœ€: {skip_count}ê°œ")
        print(f"âŒ ì‹¤íŒ¨: {error_count}ê°œ")
        print(f"{'='*60}\n")


def main():
    parser = argparse.ArgumentParser(
        description="ActiGraph íŒŒì¼ ìë™ ì´ë¦„ ë³€ê²½",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ì‚¬ìš© ì˜ˆì‹œ:
  # ê¸°ë³¸ ì‚¬ìš©ë²•
  python name.py -- 40ì£¼ì°¨
  
  # Dry-run ëª¨ë“œë¡œ ë¯¸ë¦¬ë³´ê¸°
  python name.py -- 40ì£¼ì°¨ --dry
  
  # ì—°ë„ ì§€ì •
  python name.py -- 40ì£¼ì°¨ --year 2025
  
  # ë‹¤ë¥¸ ì£¼ì°¨ ì²˜ë¦¬
  python name.py -- 1ì£¼ì°¨ --year 2024
        """
    )
    
    parser.add_argument(
        '--week',
        required=True,
        help='êµ¬ë¶„ ê°’ (ì˜ˆ: "40ì£¼ì°¨", "1ì£¼ì°¨")'
    )
    
    parser.add_argument(
        '--year',
        type=int,
        help='ì—°ë„ (ê¸°ë³¸ê°’: config.yamlì˜ defaults.year)'
    )
    
    parser.add_argument(
        '--dry',
        action='store_true',
        help='ì‹¤ì œ ë³€ê²½ ì—†ì´ ë¯¸ë¦¬ë³´ê¸°ë§Œ ìˆ˜í–‰'
    )

    parser.add_argument(
        '--no-metadata',
        action='store_true',
        help='ë©”íƒ€ë°ì´í„° ìˆ˜ì • ì—†ì´ íŒŒì¼ëª…ë§Œ ë³€ê²½ (ê¸°ë³¸: ë©”íƒ€ë°ì´í„°ë„ ìˆ˜ì •)'
    )

    parser.add_argument(
        '--config',
        default='config.yaml',
        help='ì„¤ì • íŒŒì¼ ê²½ë¡œ (ê¸°ë³¸ê°’: config.yaml)'
    )
    
    args = parser.parse_args()
    
    # ì‹¤í–‰
    try:
        renamer = ActiGraphRenamer(args.config)
        renamer.run(
            division=args.week,
            year=args.year,
            dry_run=args.dry,
            modify_metadata=not args.no_metadata
        )
    except FileNotFoundError as e:
        print(f"âŒ ì˜¤ë¥˜: íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {e}")
        sys.exit(1)
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)


if __name__ == '__main__':
    main()

```
</file>
<file path="requirements.txt">
```txt
# Requirements for agd-gt3x-renamer
# Recommended minimal versions; adjust to your environment if needed
pandas>=1.5.0
PyYAML>=6.0
openpyxl>=3.0.10

# Optional (pandas pulls these in; included for clarity)
numpy>=1.24
python-dateutil>=2.8
pytz>=2023.3

```
</file>
</files>