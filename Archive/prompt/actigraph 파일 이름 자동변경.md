# ActiGraph 파일 이름 자동 변경 프로젝트

## 📁 참조 파일

```yaml
대상자_정보_파일: "C:\Users\ding0\대학원생_김종철\OneDrive - 청주대학교\질병관리청\대상자 키,체중,주손 정보.xlsx"
  - 시트: 2024, 2025
  - 컬럼: 구분, 관리번호, ID, 이름, 성별, 나이, 키, 체중, 생년월일, 주손, 지급일, 착용 시작일, 착용시작 요일

관리번호_시리얼_매칭_파일: "C:\Users\ding0\OneDrive\문서\vscode repository\관리번호-시리얼번호.xlsx"
  - 컬럼: 관리번호, 고유번호

대상_디렉토리: "C:\Users\ding0\OneDrive\문서\ActiGraph\ActiLife\Downloads"
```

---

## 🔄 파일명 변경 로직

### 1. 기존 파일명 형식
```
고유번호 (날짜).확장자
```

**예시:**
- `MOS2D36155148 (2025-11-13).gt3x`
- `MOS2D36155148 (2025-11-13)60sec.agd`

### 2. 변경 후 파일명 형식
```
ID_이름 (착용시작일).확장자
```

**예시:**
- `JB54017302_김선옥 (2025-11-08).gt3x` ← 착용 시작일로 변경
- `JB54017302_김선옥 (2025-11-08)60sec.agd` ← 착용 시작일로 변경

**⚠️ 중요**: 날짜는 원본 파일의 날짜가 아닌 Excel의 "착용 시작일" 컬럼 값으로 자동 변경됨

---

## ⚙️ 매칭 프로세스

```
1. 파일명에서 고유번호 추출
   예: "MOS2D36155148 (2025-11-13).gt3x" → 고유번호: MOS2D36155148

2. 관리번호-시리얼번호.xlsx에서 관리번호 찾기
   고유번호: MOS2D36155148 → 관리번호: 105

3. 대상자 키,체중,주손 정보.xlsx (연도별 시트)에서 매칭
   - 조건1: 관리번호 = 105
   - 조건2: 구분 = "40주차" (CLI 옵션으로 입력)
   → 결과: ID=JB54017302, 이름=김선옥, 착용시작일=2025-11-08

4. 새 파일명 생성 (날짜는 착용 시작일로 자동 변경)
   JB54017302_김선옥 (2025-11-08).gt3x
```

### 추가 기능: 이미 변경된 파일의 날짜 자동 수정
- 파일명이 이미 `ID_이름 (날짜).확장자` 형식으로 변경되어 있어도 날짜가 틀린 경우 자동으로 재변경
- 예: `JB54011502_이희명 (2025-11-17)60sec.agd` → `JB54011502_이희명 (2025-11-06)60sec.agd`
- ID로 역조회하여 올바른 착용 시작일로 수정

---

## 🚨 핵심 문제 및 해결방안

### 문제: 1:N 관계
- 하나의 **관리번호**에 **여러 명의 대상자**가 매칭됨
- 예: 관리번호 105 → 김보민, 홍민수, 오경은, 김선옥 (총 4명)

### 해결: "구분" 컬럼으로 필터링
- **구분** 컬럼: "1주차", "2주차", "40주차" 등의 값
- **CLI 옵션**으로 구분 값을 입력받아 필터링

**사용 예시:**
```bash
python name.py --week 40주차
python name.py --week 40주차 --year 2025
python name.py --week 40주차 --dry-run
```

---

## 📋 Python 스크립트 (name.py)

### 기능
1. CLI 옵션:
   - `--week`: 구분 값 (필수, 예: "40주차")
   - `--year`: 연도 (선택, 기본값: config.yaml의 defaults.year)
   - `--dry-run`: 실제 변경 없이 미리보기
   - `--config`: 설정 파일 경로 (선택, 기본값: config.yaml)

2. 처리 대상 파일:
   - `.gt3x` 파일
   - `.agd` 파일

3. 안전장치:
   - 이미 올바르게 변경된 파일만 건너뛰기 (ID, 이름, 착용시작일 모두 일치)
   - 날짜가 틀린 경우 자동으로 재변경
   - 매칭 실패 시 로그 출력 및 건너뛰기
   - dry-run 모드로 먼저 확인 가능

4. 재사용성:
   - config.yaml로 경로 및 설정 관리
   - 단일 스크립트로 구현

### 실행 환경
- Conda 환경: `module`
- 필요 패키지: pyyaml, pandas, openpyxl

---

## ✅ 테스트 완료 케이스

### 테스트 1: 원본 파일 변경 (2025-11-14)
**파일:** `MOS2D36155148 (2025-11-13).gt3x`

**매칭 결과:**
```
ID: JB54017302
관리번호: 105
구분: 40주차
이름: 김선옥
착용 시작일: 2025-11-08
```

**변경 완료:**
- ✅ `JB54017302_김선옥 (2025-11-08).gt3x` ← 착용 시작일로 변경
- ✅ `JB54017302_김선옥 (2025-11-08)60sec.agd` ← 착용 시작일로 변경

### 테스트 2: 날짜 자동 수정 (2025-11-17)
**기존 파일:**
- `JB54011502_이희명 (2025-11-17)60sec.agd` ← 잘못된 날짜
- `MOS2A50130068 (2025-11-17).gt3x`

**매칭 결과:**
```
ID: JB54011502
이름: 이희명
착용 시작일: 2025-11-06
```

**변경 완료:**
- ✅ `JB54011502_이희명 (2025-11-06)60sec.agd` ← 날짜 자동 수정
- ✅ `JB54011502_이희명 (2025-11-06).gt3x` ← 올바른 날짜 적용

---

### 최종 실행 결과 (2025-11-17)
```
실행 명령어: conda run -n module python name.py --week 40주차 --dry

📊 처리 결과
✅ 성공: 2개
  - JB54011502_이희명 (2025-11-17)60sec.agd → JB54011502_이희명 (2025-11-06)60sec.agd
  - MOS2A50130068 (2025-11-17).gt3x → JB54011502_이희명 (2025-11-06).gt3x
⏭️  건너뜀: 0개
❌ 실패: 0개
```

### 사용법
```bash
# 기본 사용 (2025년 기본값)
conda run -n module python name.py --week 40주차

# 미리보기 모드
conda run -n module python name.py --week 40주차 --dry-run

# 특정 연도 지정
conda run -n module python name.py --week 1주차 --year 2024
```